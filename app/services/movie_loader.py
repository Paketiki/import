from typing import List, Dict, Optional
from sqlalchemy.orm import Session
from app.models.movies import Movie, MoviePick
from app.models.picks import Pick
import logging

logger = logging.getLogger(__name__)

# Movie data from the user's request
MOVIES = [
    {
        "id": 1,
        "title": "Побег из Шоушенка",
        "year": 1994,
        "genre": "Драма",
        "rating": 9.3,
        "picks": ["hits", "classic"],
        "poster": "https://picsum.photos/seed/film1/200/300",
        "overview": "Банкир Энди Дюфрейн, обвинённый в убийстве жены и её любовника, попадает в тюрьму Шоушенк.",
        "review": "Фильм о силе надежды и достоинства, который мягко подводит к мощному катарсису и долго не отпускает после финала.",
        "extraReviews": [
            "Один из тех редких случаев, когда душевность и драматизм идеально уравновешены.",
        ],
    },
    {
        "id": 2,
        "title": "Тёмный рыцарь",
        "year": 2008,
        "genre": "Боевик",
        "rating": 9.0,
        "picks": ["hits"],
        "poster": "https://picsum.photos/seed/film2/200/300",
        "overview": "Бэтмен вступает в смертельную игру с Джокером, чья цель — погрузить город в хаос.",
        "review": "Нолан превращает супергеройский фильм в мрачную криминальную драму с одним из лучших злодеев в истории кино.",
        "extraReviews": [
            "Напряжение не спадает ни на минуту, а моральные дилеммы героев остаются в голове надолго.",
        ],
    },
    {
        "id": 3,
        "title": "Начало",
        "year": 2010,
        "genre": "Фантастика",
        "rating": 8.8,
        "picks": ["hits", "new"],
        "poster": "https://picsum.photos/seed/film3/200/300",
        "overview": "Профессиональный вор, специализирующийся на проникновении в сны, получает шанс на искупление.",
        "review": "Интеллектуальный блокбастер, который предлагает зрителю собрать головоломку из снов и воспоминаний.",
        "extraReviews": [
            "Фильм, к которому хочется возвращаться, чтобы заметить новые детали в каждом уровне сна.",
        ],
    },
    {
        "id": 4,
        "title": "Интерстеллар",
        "year": 2014,
        "genre": "Фантастика",
        "rating": 8.6,
        "picks": ["hits", "new"],
        "poster": "https://picsum.photos/seed/film4/200/300",
        "overview": "Команда исследователей отправляется через червоточину в поисках нового дома для человечества.",
        "review": "Космическая драма о родительской любви и цене прогресса, совмещающая научные идеи и искренние эмоции.",
        "extraReviews": [
            "Редкий пример фильма, где масштаб вселенной не перекрывает человеческую историю.",
        ],
    },
    {
        "id": 5,
        "title": "Форрест Гамп",
        "year": 1994,
        "genre": "Драма",
        "rating": 8.9,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film5/200/300",
        "overview": "История простодушного Форреста, который становится свидетелем важнейших событий в истории США.",
        "review": "Трогательная притча о доброте и принятии, в которой хочется улыбаться и плакать одновременно.",
        "extraReviews": [
            "Фильм, к которому возвращаются как к старому другу — он всегда дарит немного тепла.",
        ],
    },
    {
        "id": 6,
        "title": "Матрица",
        "year": 1999,
        "genre": "Фантастика",
        "rating": 8.7,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film6/200/300",
        "overview": "Программист Нео узнаёт, что реальность — всего лишь симуляция, созданная машинами.",
        "review": "Революционный боевик, который подарил кино новый визуальный язык и заставил задуматься о природе реальности.",
        "extraReviews": [
            "Удивительно, как фильм конца 90-х до сих пор остаётся свежим и актуальным.",
        ],
    },
    {
        "id": 7,
        "title": "Однажды в… Голливуде",
        "year": 2019,
        "genre": "Комедия",
        "rating": 7.7,
        "picks": ["new"],
        "poster": "https://picsum.photos/seed/film7/200/300",
        "overview": "Актёр Рик Далтон и его дублёр Клифф Бут пытаются найти себя в меняющемся Голливуде 60-х.",
        "review": "Неторопливая, ностальгическая прогулка по мифическому Голливуду, где каждый кадр — любовное письмо кино.",
        "extraReviews": [
            "Финал балансирует между жестокостью и сказкой, оставляя очень странное, но яркое послевкусие.",
        ],
    },
    {
        "id": 8,
        "title": "Паразиты",
        "year": 2019,
        "genre": "Драма",
        "rating": 8.5,
        "picks": ["hits", "new"],
        "poster": "https://picsum.photos/seed/film8/200/300",
        "overview": "Бедная семья постепенно захватывает места в доме богатых, притворяясь специалистами.",
        "review": "Идеально выстроенная социальная сатира, которая незаметно превращается в мрачный триллер.",
        "extraReviews": [
            "Каждый поворот сюжета выбивает почву из-под ног и заставляет пересмотреть симпатии к героям.",
        ],
    },
    {
        "id": 9,
        "title": "Бегущий по лезвию 2049",
        "year": 2017,
        "genre": "Фантастика",
        "rating": 8.0,
        "picks": ["new"],
        "poster": "https://picsum.photos/seed/film9/200/300",
        "overview": "Новый бегущий по лезвию раскрывает тайну, способную изменить отношения людей и репликантов.",
        "review": "Медитативный неонуар, в котором визуал и звук работают как единое гипнотическое полотно.",
        "extraReviews": [
            "Фильм требует терпения, но щедро награждает атмосферой и философскими вопросами.",
        ],
    },
    {
        "id": 10,
        "title": "Криминальное чтиво",
        "year": 1994,
        "genre": "Боевик",
        "rating": 8.9,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film10/200/300",
        "overview": "Переплетающиеся истории гангстеров, боксёра и грабителей в Лос-Анджелесе.",
        "review": "Культовый фильм с фирменными диалогами и нелинейным монтажом, который до сих пор копируют.",
        "extraReviews": [
            "Каждая сцена — отдельный маленький шедевр, который хочется цитировать.",
        ],
    },
    {
        "id": 11,
        "title": "Крёстный отец",
        "year": 1972,
        "genre": "Драма",
        "rating": 9.2,
        "picks": ["classic", "hits"],
        "poster": "https://picsum.photos/seed/film11/200/300",
        "overview": "Сага о мафиозном клане Корлеоне и передаче власти от отца к сыну.",
        "review": "Образцовый образец гангстерской драмы, в которой семейная трагедия важнее криминала.",
        "extraReviews": [
            "Медленный ритм только усиливает ощущение трагического падения героев.",
        ],
    },
    {
        "id": 12,
        "title": "Крёстный отец 2",
        "year": 1974,
        "genre": "Драма",
        "rating": 9.0,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film12/200/300",
        "overview": "Параллельная история молодого Вито и взросления Майкла Корлеоне.",
        "review": "Редкий сиквел, который не уступает оригиналу и даже расширяет его трагедию.",
    },
    {
        "id": 13,
        "title": "Список Шиндлера",
        "year": 1993,
        "genre": "Драма",
        "rating": 9.0,
        "picks": ["classic", "hits"],
        "poster": "https://picsum.photos/seed/film13/200/300",
        "overview": "Немецкий промышленник спасает сотни евреев во время Холокоста.",
        "review": "Жёсткая и честная картина о геноциде, которая не оставляет шанса остаться равнодушным.",
        "extraReviews": [
            "Чёрно-белое изображение только усиливает документальное ощущение происходящего.",
        ],
    },
    {
        "id": 14,
        "title": "Зелёная миля",
        "year": 1999,
        "genre": "Драма",
        "rating": 9.0,
        "picks": ["hits", "classic"],
        "poster": "https://picsum.photos/seed/film14/200/300",
        "overview": "Тюремный надзиратель встречает осуждённого с необычным даром.",
        "review": "Трогательное сочетание мистики и тюремной драмы, которое бьёт прямо в сердце.",
    },
    {
        "id": 15,
        "title": "Властелин колец: Братство Кольца",
        "year": 2001,
        "genre": "Фэнтези",
        "rating": 8.8,
        "picks": ["hits", "classic"],
        "poster": "https://picsum.photos/seed/film15/200/300",
        "overview": "Хоббит Фродо отправляется в опасное путешествие, чтобы уничтожить Кольцо Всевластья.",
        "review": "Эпическое фэнтези, задавшее планку масштабных экранизаций на годы вперёд.",
    },
    {
        "id": 16,
        "title": "Властелин колец: Две крепости",
        "year": 2002,
        "genre": "Фэнтези",
        "rating": 8.8,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film16/200/300",
        "overview": "Братство распалось, но борьба с силами Саурона продолжается на разных фронтах.",
        "review": "Средняя часть трилогии, в которой битвы становятся масштабнее, а ставки — выше.",
    },
    {
        "id": 17,
        "title": "Властелин колец: Возвращение короля",
        "year": 2003,
        "genre": "Фэнтези",
        "rating": 8.9,
        "picks": ["hits", "classic"],
        "poster": "https://picsum.photos/seed/film17/200/300",
        "overview": "Финальная битва за Средиземье и последняя попытка уничтожить Кольцо.",
        "review": "Фееричный финал трилогии, который соединяет масштабные битвы и личные истории героев.",
    },
    {
        "id": 18,
        "title": "Бойцовский клуб",
        "year": 1999,
        "genre": "Драма",
        "rating": 8.8,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film18/200/300",
        "overview": "Офисный работник создаёт подпольный клуб, где мужчины избивают друг друга ради ощущения жизни.",
        "review": "Провокационный фильм о кризисе идентичности и культуре потребления.",
    },
    {
        "id": 19,
        "title": "Пираты Карибского моря: Проклятие Чёрной жемчужины",
        "year": 2003,
        "genre": "Боевик",
        "rating": 8.0,
        "picks": ["hits"],
        "poster": "https://picsum.photos/seed/film19/200/300",
        "overview": "Экстравагантный капитан Джек Воробей ввязывается в приключение с проклятыми пиратами.",
        "review": "Развлекательный приключенческий фильм, который держится на харизме Джонни Деппа.",
    },
    {
        "id": 20,
        "title": "Гладиатор",
        "year": 2000,
        "genre": "Боевик",
        "rating": 8.5,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film20/200/300",
        "overview": "Римский полководец становится рабом и выходит на арену, чтобы отомстить за семью.",
        "review": "Исторический эпос с сильной эмоциональной линией и мощными батальными сценами.",
    },
    {
        "id": 21,
        "title": "Титаник",
        "year": 1997,
        "genre": "Драма",
        "rating": 8.0,
        "picks": ["classic", "hits"],
        "poster": "https://picsum.photos/seed/film21/200/300",
        "overview": "История любви на фоне крушения легендарного лайнера «Титаник».",
        "review": "Мелодрама и катастрофа, сплетённые в один большой кинематографический аттракцион.",
    },
    {
        "id": 22,
        "title": "Индиана Джонс: В поисках утраченного ковчега",
        "year": 1981,
        "genre": "Боевик",
        "rating": 8.4,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film22/200/300",
        "overview": "Археолог Индиана Джонс пытается опередить нацистов в поисках Ковчега Завета.",
        "review": "Эталонное приключенческое кино, где каждое препятствие — запоминающаяся сцена.",
    },
    {
        "id": 23,
        "title": "Назад в будущее",
        "year": 1985,
        "genre": "Фантастика",
        "rating": 8.5,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film23/200/300",
        "overview": "Подросток Марти МакФлай случайно отправляется в прошлое на машине времени.",
        "review": "Идеальная смесь фантастики, комедии и семейной драмы, которая до сих пор смотрится на одном дыхании.",
    },
    {
        "id": 24,
        "title": "Терминатор 2: Судный день",
        "year": 1991,
        "genre": "Боевик",
        "rating": 8.5,
        "picks": ["classic", "hits"],
        "poster": "https://picsum.photos/seed/film24/200/300",
        "overview": "Киборг из будущего должен защитить мальчика Джона Коннора от более совершенной машины убийства.",
        "review": "Один из лучших боевиков всех времён с революционными спецэффектами.",
    },
    {
        "id": 25,
        "title": "Чужой",
        "year": 1979,
        "genre": "Ужасы",
        "rating": 8.4,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film25/200/300",
        "overview": "Экипаж космического корабля сталкивается с неизвестной формой жизни.",
        "review": "Клаустрофобный космический хоррор, который берёт не количеством монстров, а атмосферой.",
    },
    {
        "id": 26,
        "title": "Чужие",
        "year": 1986,
        "genre": "Боевик",
        "rating": 8.3,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film26/200/300",
        "overview": "Рипли возвращается на планету, где впервые столкнулся с ксеноморфом, но теперь там целая колония.",
        "review": "Удачное превращение хоррора в военный боевик, не потерявший напряжения оригинала.",
    },
    {
        "id": 27,
        "title": "Город Бога",
        "year": 2002,
        "genre": "Драма",
        "rating": 8.6,
        "picks": ["hits"],
        "poster": "https://picsum.photos/seed/film27/200/300",
        "overview": "История роста преступности в трущобах Рио-де-Жанейро глазами подростков.",
        "review": "Жестокая, но невероятно живая картина о том, как легко насилие становится нормой.",
    },
    {
        "id": 28,
        "title": "Красота по-американски",
        "year": 1999,
        "genre": "Драма",
        "rating": 8.4,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film28/200/300",
        "overview": "Кризис среднего возраста толкает главного героя на попытку изменить свою жизнь.",
        "review": "Ироничный и грустный взгляд на «идеальную» пригородную жизнь и внутреннюю пустоту.",
    },
    {
        "id": 29,
        "title": "Большой Лебовски",
        "year": 1998,
        "genre": "Комедия",
        "rating": 8.1,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film29/200/300",
        "overview": "Флегматичный Чувак оказывается втянутым в детективную историю из-за ошибки с личностью.",
        "review": "Абсурдная криминальная комедия, которая за годы превратилась в культ.",
    },
    {
        "id": 30,
        "title": "Амели",
        "year": 2001,
        "genre": "Комедия",
        "rating": 8.3,
        "picks": ["hits"],
        "poster": "https://picsum.photos/seed/film30/200/300",
        "overview": "Застенчивая Амели решает тайно помогать людям вокруг и менять их жизнь к лучшему.",
        "review": "Визуальная сказка о маленьких радостях, которая поднимает настроение даже в хмурый день.",
    },
    {
        "id": 31,
        "title": "Молчание ягнят",
        "year": 1991,
        "genre": "Триллер",
        "rating": 8.6,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film31/200/300",
        "overview": "Молодая агент ФБР обращается за помощью к заключённому маньяку Ганнибалу Лектеру.",
        "review": "Холодящий кровь триллер, который держится на дуэли двух сильных персонажей.",
    },
    {
        "id": 32,
        "title": "Семь",
        "year": 1995,
        "genre": "Триллер",
        "rating": 8.6,
        "picks": ["classic", "hits"],
        "poster": "https://picsum.photos/seed/film32/200/300",
        "overview": "Два детектива охотятся за серийным убийцей, вдохновляющимся семью смертными грехами.",
        "review": "Мрачный и безжалостный фильм, финал которого сложно забыть.",
    },
    {
        "id": 33,
        "title": "Престиж",
        "year": 2006,
        "genre": "Драма",
        "rating": 8.5,
        "picks": ["hits"],
        "poster": "https://picsum.photos/seed/film33/200/300",
        "overview": "Два фокусника превращают соперничество в разрушительную одержимость.",
        "review": "Стильный триллер о цене успеха, где каждый сюжетный «фокус» имеет свою жертву.",
    },
    {
        "id": 34,
        "title": "Остров проклятых",
        "year": 2010,
        "genre": "Триллер",
        "rating": 8.1,
        "picks": ["hits"],
        "poster": "https://picsum.photos/seed/film34/200/300",
        "overview": "Маршал США прибывает в психиатрическую клинику на острове, чтобы расследовать исчезновение пациентки.",
        "review": "Напряжённый психологический триллер, играющий с восприятием реальности героя.",
    },
    {
        "id": 35,
        "title": "В джазе только девушки",
        "year": 1959,
        "genre": "Комедия",
        "rating": 8.5,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film35/200/300",
        "overview": "Два музыканта переодеваются женщинами, чтобы скрыться от гангстеров.",
        "review": "Классическая комедия положений, которая до сих пор выглядит свежо и остроумно.",
    },
    {
        "id": 36,
        "title": "Таксист",
        "year": 1976,
        "genre": "Драма",
        "rating": 8.3,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film36/200/300",
        "overview": "Одинокий таксист постепенно теряет связь с реальностью на фоне ночного Нью-Йорка.",
        "review": "Гнетущий портрет одиночества и внутреннего распада на фоне большого города.",
    },
    {
        "id": 37,
        "title": "Пролетая над гнездом кукушки",
        "year": 1975,
        "genre": "Драма",
        "rating": 8.7,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film37/200/300",
        "overview": "Харизматичный заключённый попадает в психиатрическую клинику и сталкивается с жестким порядком.",
        "review": "Фильм о свободе и системе, который одновременно смешной и страшный.",
    },
    {
        "id": 38,
        "title": "Ла-Ла Ленд",
        "year": 2016,
        "genre": "Мюзикл",
        "rating": 8.0,
        "picks": ["new"],
        "poster": "https://picsum.photos/seed/film38/200/300",
        "overview": "Джазовый музыкант и актриса пытаются построить карьеру и сохранить отношения.",
        "review": "Современный мюзикл о мечтах и компромиссах, влюблённый в классику Голливуда.",
    },
    {
        "id": 39,
        "title": "Безумный Макс: Дорога ярости",
        "year": 2015,
        "genre": "Боевик",
        "rating": 8.1,
        "picks": ["hits", "new"],
        "poster": "https://picsum.photos/seed/film39/200/300",
        "overview": "В постапокалиптической пустыне беглецы пытаются уйти от тирана на боевой фуре.",
        "review": "Почти непрерывная погоня, превращённая в визуальное искусство.",
    },
    {
        "id": 40,
        "title": "Социальная сеть",
        "year": 2010,
        "genre": "Драма",
        "rating": 7.7,
        "picks": ["new"],
        "poster": "https://picsum.photos/seed/film40/200/300",
        "overview": "История создания Facebook и конфликта между его основателями.",
        "review": "Динамичная драма о дружбе, амбициях и цене успеха в цифровую эпоху.",
    },
    {
        "id": 41,
        "title": "Гравитация",
        "year": 2013,
        "genre": "Фантастика",
        "rating": 7.7,
        "picks": ["new"],
        "poster": "https://picsum.photos/seed/film41/200/300",
        "overview": "Двое астронавтов пытаются выжить после катастрофы на орбите Земли.",
        "review": "Иммерсивный космический триллер, который лучше всего работает на большом экране.",
    },
    {
        "id": 42,
        "title": "Выживший",
        "year": 2015,
        "genre": "Драма",
        "rating": 7.8,
        "picks": ["new"],
        "poster": "https://picsum.photos/seed/film42/200/300",
        "overview": "Охотник Хью Гласс, оставленный умирать, пытается добраться до тех, кто его предал.",
        "review": "Жёсткая выживательная драма с потрясающими природными видами и физически ощутимым страданием героя.",
    },
    {
        "id": 43,
        "title": "Джанго освобождённый",
        "year": 2012,
        "genre": "Вестерн",
        "rating": 8.4,
        "picks": ["hits"],
        "poster": "https://picsum.photos/seed/film43/200/300",
        "overview": "Освобождённый раб объединяется с охотником за головами, чтобы спасти жену.",
        "review": "Стильный и кровавый вестерн Тарантино с фирменными диалогами и саундтреком.",
    },
    {
        "id": 44,
        "title": "Мстители: Финал",
        "year": 2019,
        "genre": "Боевик",
        "rating": 8.4,
        "picks": ["hits", "new"],
        "poster": "https://picsum.photos/seed/film44/200/300",
        "overview": "Герои объединяются, чтобы исправить последствия щелчка Таноса.",
        "review": "Эмоциональное завершение многолетней саги Marvel, работающее как большое прощание с героями.",
    },
    {
        "id": 45,
        "title": "Храброе сердце",
        "year": 1995,
        "genre": "Драма",
        "rating": 8.3,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film45/200/300",
        "overview": "Шотландский воин Уильям Уоллес поднимает восстание против английской короны.",
        "review": "Патетический, но мощный исторический эпос с впечатляющими битвами.",
    },
    {
        "id": 46,
        "title": "Лица со шрамами",
        "year": 1983,
        "genre": "Драма",
        "rating": 8.3,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film46/200/300",
        "overview": "Иммигрант Тони Монтана поднимается на вершину криминального мира Майами.",
        "review": "Грубое и хлёсткое исследование одержимости властью и деньгами.",
    },
    {
        "id": 47,
        "title": "Реквием по мечте",
        "year": 2000,
        "genre": "Драма",
        "rating": 8.3,
        "picks": ["hits"],
        "poster": "https://picsum.photos/seed/film47/200/300",
        "overview": "История нескольких людей, чьи мечты разрушаются под тяжестью зависимостей.",
        "review": "Жестокий и визуально экспериментальный фильм, после которого сложно прийти в себя.",
    },
    {
        "id": 48,
        "title": "Под покровом ночи",
        "year": 2016,
        "genre": "Триллер",
        "rating": 7.5,
        "picks": ["new"],
        "poster": "https://picsum.photos/seed/film48/200/300",
        "overview": "Героиня читает мрачный роман бывшего мужа, который отражает их прошлое.",
        "review": "Стильный неонуар о мести и чувствах вины, рассказанный через историю внутри истории.",
    },
    {
        "id": 49,
        "title": "Преступление и наказание (советская экранизация)",
        "year": 1969,
        "genre": "Драма",
        "rating": 7.9,
        "picks": ["classic"],
        "poster": "https://picsum.photos/seed/film49/200/300",
        "overview": "Экранизация романа Достоевского о преступлении, раскаянии и поиске смысла.",
        "review": "Внимательное к тексту произведение, где акцент сделан на внутренней борьбе персонажей.",
    },
    {
        "id": 50,
        "title": "Нефть",
        "year": 2007,
        "genre": "Драма",
        "rating": 8.1,
        "picks": ["hits"],
        "poster": "https://picsum.photos/seed/film50/200/300",
        "overview": "Амбициозный нефтяник строит империю и теряет остатки человечности.",
        "review": "Удивительно, как фильм конца 90-х до сих пор остаётся свежим и актуальным.",
    },
]


class MovieLoader:
    def __init__(self, db: Session):
        self.db = db

    def load_movies_from_list(self, created_by_user_id: Optional[int] = None, skip_existing: bool = True) -> Dict:
        """
        Загружает фильмы из встроенного списка в базу данных
        
        Args:
            created_by_user_id: ID пользователя, который создал фильмы
            skip_existing: Пропускать уже существующие фильмы
            
        Returns:
            Dict: Результат операции с информацией о загрузке
        """
        try:
            loaded_count = 0
            skipped_count = 0
            errors = []
            
            # Получаем или создаем необходимые picks
            pick_cache = {}
            for movie_data in MOVIES:
                for pick_name in movie_data.get("picks", []):
                    if pick_name not in pick_cache:
                        pick = self.db.query(Pick).filter(Pick.name == pick_name).first()
                        if not pick:
                            pick = Pick(name=pick_name)
                            self.db.add(pick)
                            self.db.flush()  # Получаем ID без коммита
                        pick_cache[pick_name] = pick.id
            
            # Загружаем фильмы
            for movie_data in MOVIES:
                try:
                    # Проверяем, существует ли фильм
                    existing_movie = self.db.query(Movie).filter(Movie.title == movie_data["title"]).first()
                    if existing_movie and skip_existing:
                        skipped_count += 1
                        continue
                    
                    # Создаем новый фильм
                    new_movie = Movie(
                        title=movie_data["title"],
                        description=movie_data.get("overview", ""),
                        release_year=movie_data["year"],
                        genre=movie_data["genre"],
                        rating=movie_data["rating"],
                        poster=movie_data.get("poster", ""),
                        created_by=created_by_user_id
                    )
                    
                    self.db.add(new_movie)
                    self.db.flush()  # Получаем ID фильма
                    
                    # Добавляем связи с picks
                    for pick_name in movie_data.get("picks", []):
                        pick_id = pick_cache[pick_name]
                        # Проверяем, существует ли уже такая связь
                        existing_pick = self.db.query(MoviePick).filter(
                            MoviePick.movie_id == new_movie.id,
                            MoviePick.pick_id == pick_id
                        ).first()
                        
                        if not existing_pick:
                            movie_pick = MoviePick(
                                movie_id=new_movie.id,
                                pick_id=pick_id,
                                added_by=created_by_user_id or 1  # Если нет пользователя, используем 1
                            )
                            self.db.add(movie_pick)
                    
                    loaded_count += 1
                    
                except Exception as e:
                    errors.append(f"Error loading movie '{movie_data['title']}': {str(e)}")
                    continue
            
            self.db.commit()
            
            return {
                "total_in_file": len(MOVIES),
                "loaded": loaded_count,
                "skipped": skipped_count,
                "errors": errors
            }
            
        except Exception as e:
            self.db.rollback()
            return {
                "error": f"Failed to load movies: {str(e)}"
            }